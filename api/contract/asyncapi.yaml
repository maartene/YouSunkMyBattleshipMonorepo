asyncapi: '2.0.0'
id: 'urn:asyncapi:YouSunkMyBattleship:0.1.0'
tags:
  - name: game
    description: WebSocket game channel
info:
  title: Battleship WebSocket API
  version: '0.1.0'
  description: |
    AsyncAPI contract for a Battleship game played over a single WebSocket
    connection. The client is presentation-focused; all game logic, state and
    bots live on the server.

    This spec is geared towards using the AsyncAPI CLI + generators to mock
    the server while you build the iOS client.

  contact:
    name: YouSunkMyBattleship Maintainers
    url: 'https://github.com/maartene/YouSunkMyBattleship'
    email: devnull@example.com
  license:
    name: MIT
    url: 'https://opensource.org/licenses/MIT'

defaultContentType: application/json

servers:
  production:
    url: wss://api.example.com
    protocol: wss
    description: Production Battleship WebSocket endpoint
  local:
    url: ws://localhost:8080
    protocol: ws
    description: Local development WebSocket endpoint

channels:
  /game:
    description: |
      Single WebSocket channel. Once connected, the client and server
      exchange JSON messages defined by the messages below.
    publish:
      operationId: clientSendGameMessage
      summary: Client → Server messages
      message:
        oneOf:
          - $ref: '#/components/messages/ClientConnect'
          - $ref: '#/components/messages/PlaceShips'
          - $ref: '#/components/messages/FireShot'
    subscribe:
      operationId: serverSendGameMessage
      summary: Server → Client messages
      message:
        oneOf:
          - $ref: '#/components/messages/ServerConnected'
          - $ref: '#/components/messages/GameStateUpdate'
          - $ref: '#/components/messages/Error'

# Note: Operation mappings have been moved into the channel as
# `publish` (client → server) and `subscribe` (server → client) to
# conform with AsyncAPI 2.0.0 structure.

components:
  messages:
    # ---------- CLIENT → SERVER ----------

    ClientConnect:
      name: ClientConnect
      title: Client connects
      summary: Initial handshake payload from client after WebSocket is open.
      description: |
        This message is optional but useful for correlating clients and
        sessions, and for future authentication/authorization.
      payload:
        $ref: '#/components/schemas/ClientConnectPayload'

    PlaceShips:
      name: PlaceShips
      title: Place ships
      summary: Send full ship placement once the user finished placing ships.
      payload:
        $ref: '#/components/schemas/PlaceShipsPayload'

    FireShot:
      name: FireShot
      title: Fire shot
      summary: Fire a shot at a coordinate on the opponent's board.
      payload:
        $ref: '#/components/schemas/FireShotPayload'

    # ---------- SERVER → CLIENT ----------

    ServerConnected:
      name: ServerConnected
      title: Server connected
      summary: Server confirms connection and provides initial game metadata.
      payload:
        $ref: '#/components/schemas/ServerConnectedPayload'

    GameStateUpdate:
      name: GameStateUpdate
      title: Game state update
      summary: Server sends full game state whenever something changes.
      description: |
        Contains both boards, a user-facing message and the current game state.
        The boards are represented as 10x10 arrays of strings.
      payload:
        $ref: '#/components/schemas/GameStateUpdatePayload'

    Error:
      name: Error
      title: Error
      summary: Error message from server to client.
      payload:
        $ref: '#/components/schemas/ErrorPayload'

  schemas:
    # ---------- COMMON ----------

    UUID:
      type: string
      format: uuid
      description: UUID v4 identifier.

    Coordinate:
      type: string
      description: Board coordinate using 'letter'-'number' format (e.g. A5).

    CellState:
      type: string
      description: |
        Cell state on a board. The exact codes are up to the server
        implementation; these are suggested values to help mocking.

    Board:
      type: object
      description: 10x10 board represented as a 2D array of strings.
      properties:
        cells:
          type: array
          minItems: 10
          maxItems: 10
          items:
            type: array
            minItems: 10
            maxItems: 10
            items:
              $ref: '#/components/schemas/CellState'
      required:
        - cells

    GameStateEnum:
      type: string
      description: |
        High-level state of the game. Add more as needed (e.g. 'waiting-for-opponent').
      enum:
        - notStarted
        - play
        - finished

    # ---------- CLIENT → SERVER PAYLOADS ----------

    ClientConnectPayload:
      type: object
      properties:
        type:
          type: string
          const: client.connect
        clientId:
          type: string
      required:
        - type
        - clientId

    ShipPlacement:
      type: object
      description: |
        Ship definition. Coordinates are inclusive start and end cells.
        For straight ships, either row or column must match.
      properties:
        name:
          type: string
          description: Ship type.
          enum:
            - carrier
            - battleship
            - cruiser
            - submarine
            - destroyer
        coordinates:
          type: array
          description: All coordinates of the ship.
          items:
            $ref: '#/components/schemas/Coordinate'
      required:
        - type
        - coordinates

    PlaceShipsPayload:
      type: object
      description: |
        Sent once the player finishes placing all ships on their board.
      properties:
        ships:
          type: array
          description: Full list of ships and their positions.
          items:
            $ref: '#/components/schemas/ShipPlacement'
          minItems: 5
          maxItems: 5
      required:
        - ships

    FireShotPayload:
      type: object
      description: Fire a shot at the opponent’s board.
      properties:
        target:
          $ref: '#/components/schemas/Coordinate'
      required:
        - target

    # ---------- SERVER → CLIENT PAYLOADS ----------

    ServerConnectedPayload:
      type: object
      properties:
        type:
          type: string
          const: server.connected
        message:
          type: string
          description: Human-readable message to show on initial connect.
          example: 'CONNECTED'
      required:
        - type

    GameStateUpdatePayload:
      type: object
      description: |
        Full game state snapshot, sent whenever something changes
        (ship placement accepted, a shot is fired, a ship is sunk, game ends, etc.).
      properties:
        type:
          type: string
          const: server.gameStateUpdate
        playerBoard:
          $ref: '#/components/schemas/Board'
        opponentBoard:
          $ref: '#/components/schemas/Board'
        gameState:
          $ref: '#/components/schemas/GameStateEnum'
        message:
          type: string
          description: |
            User-facing message, e.g. 'You sunk my battleship!', 'Your turn',
            'Game over – you win', etc.
        shipsToDestroy:
          type: number
          description: Number of ships that remain to destroy
        currentTurn:
          type: string
          description: Whose turn it is.
          enum:
            - player
            - opponent
      required:
        - type
        - playerBoard
        - opponentBoard
        - gameState
        - shipsToDestroy
        - message

    ErrorPayload:
      type: object
      properties:
        type:
          type: string
          const: server.error
        gameId:
          $ref: '#/components/schemas/UUID'
          nullable: true
        code:
          type: string
          description: Machine-readable error code.
          examples:
            - INVALID_SHIP_PLACEMENT
            - INVALID_COORDINATE
            - NOT_YOUR_TURN
        message:
          type: string
          description: Human-readable error message.
        correlationId:
          type: string
          description: |
            ID that allows client to correlate an error to the request it sent.
      required:
        - type
        - code
        - message