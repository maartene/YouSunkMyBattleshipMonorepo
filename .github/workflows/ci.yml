name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    environment: ci
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install curl
        run: |
          sudo apt install curl -y

      - name: Install Swift version
        run: |
          curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz && \
          tar zxf swiftly-$(uname -m).tar.gz && \
          ./swiftly init --quiet-shell-followup && \
          . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh" && \
          hash -r          
        
      - name: Build and test YouSunkMyBattleshipCommon
        working-directory: YouSunkMyBattleshipCommon
        run: |
          set -e
          swift build
          swift test --enable-code-coverage

      #- name: Build and test YouSunkMyBattleshipBE
      #  working-directory: YouSunkMyBattleshipBE
      #  run: |
      #    set -e
      #    swift build
      #    swift test --enable-code-coverage

      - name: Collect coverage data
        run: |
          set -e
          mkdir -p coverage
          
          # Convert Swift coverage to LCOV format for SonarCloud
          if [ -d "YouSunkMyBattleshipCommon/.build/debug/codecov" ]; then
            echo "Converting YouSunkMyBattleshipCommon coverage..."
            mkdir -p coverage/common
            
            # Use the existing default.profdata that Swift creates
            PROFDATA="YouSunkMyBattleshipCommon/.build/debug/codecov/default.profdata"
            
            if [ -f "$PROFDATA" ]; then
              # Find any executable in the build directory for source mapping
              BINARY=$(find YouSunkMyBattleshipCommon/.build/debug -type f -perm -u+x ! -name "*.o" ! -name "*.d" 2>/dev/null | head -1)
              
              if [ -z "$BINARY" ]; then
                # Fallback: look for any file in the build root that might be the binary
                BINARY=$(ls -t YouSunkMyBattleshipCommon/.build/debug/*/Package/Sources/*/.build/debug/* 2>/dev/null | head -1)
              fi
              
              if [ -n "$BINARY" ]; then
                echo "Using binary: $BINARY"
                echo "Using profdata: $PROFDATA"
                xcrun llvm-cov export "$BINARY" \
                  -instr-profile="$PROFDATA" \
                  -format=lcov \
                  > coverage/common/coverage.lcov 2>&1 || \
                echo "Note: llvm-cov export completed (check output above for any warnings)"
              else
                # Fallback: Try without a specific binary, using just the profdata
                echo "Could not find binary, attempting export with profdata only..."
                # For SPM projects, we may need a different approach
                # Let's try to find test executables
                TEST_BINARY=$(find YouSunkMyBattleshipCommon/.build -name "*Tests" -type f 2>/dev/null | head -1)
                if [ -n "$TEST_BINARY" ]; then
                  echo "Found test binary: $TEST_BINARY"
                  xcrun llvm-cov export "$TEST_BINARY" \
                    -instr-profile="$PROFDATA" \
                    -format=lcov \
                    > coverage/common/coverage.lcov 2>&1 || \
                  echo "Note: Coverage export completed"
                else
                  echo "Warning: Could not find any binary for coverage export"
                  ls -la YouSunkMyBattleshipCommon/.build/debug/ || true
                fi
              fi
            else
              echo "Warning: No profdata found at $PROFDATA"
            fi
          fi
          
          # List coverage files for debugging
          echo "Coverage files available:"
          find coverage -type f 2>/dev/null | head -20 || echo "No coverage files found"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=maartene_YouSunkMyBattleshipMonorepo
            -Dsonar.projectName=YouSunkMyBattleshipMonorepo
            -Dsonar.organization=maartene
            -Dsonar.branch.name=${{ github.ref_name }}
            -Dsonar.qualitygate.wait=false

      
          
  # smoketest:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
      
  #     - name: Install Swift version
  #       uses: swift-actions/setup-swift@v3

  #     - name: Run smoketest
  #       run: |
  #         set -e
  #         chmod +x smoketest.sh
  #         ./smoketest.sh
        
    
