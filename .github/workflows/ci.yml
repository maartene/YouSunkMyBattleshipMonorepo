name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    environment: ci
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install curl
        run: |
          sudo apt install curl -y

      - name: Install Swift version
        run: |
          curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz && \
          tar zxf swiftly-$(uname -m).tar.gz && \
          ./swiftly init --quiet-shell-followup && \
          . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh" && \
          hash -r          
        
      - name: Build and test YouSunkMyBattleshipCommon
        working-directory: YouSunkMyBattleshipCommon
        run: |
          set -e
          swift build
          swift test --enable-code-coverage

      - name: Build and test YouSunkMyBattleshipBE
        working-directory: YouSunkMyBattleshipBE
        run: |
          set -e
          swift build
          swift test --enable-code-coverage

      - name: Collect coverage data
        run: |
          set -e
          
          # Source swiftly environment to get access to Swift toolchain (including llvm-cov)
          . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          
          mkdir -p coverage
          
          echo "Swift location: $(which swift)"
          echo "llvm-cov location: $(which llvm-cov || echo 'not found')"

          # Convert Swift coverage to LCOV format for SonarCloud
          if [ -d "YouSunkMyBattleshipCommon/.build" ]; then
            echo "Converting YouSunkMyBattleshipCommon coverage..."
            mkdir -p coverage/common

            # Try to find the default.profdata generated by Swift on Linux or macOS
            PROFDATA=$(find YouSunkMyBattleshipCommon/.build -name "default.profdata" -print -quit || true)

            if [ -n "$PROFDATA" ] && [ -f "$PROFDATA" ]; then
              echo "Found profdata: $PROFDATA"

              # Find an executable under .build (test executable or product)
              BINARY=$(find YouSunkMyBattleshipCommon/.build -type f -perm /111 -print -quit || true)

              if [ -n "$BINARY" ]; then
                echo "Using binary: $BINARY"
                
                # Use llvm-cov from Swift toolchain (should be in PATH after sourcing env.sh)
                if command -v llvm-cov >/dev/null 2>&1; then
                  llvm-cov export "$BINARY" -instr-profile="$PROFDATA" -format=lcov > coverage/common/coverage.lcov 2>&1 || true
                  
                  if [ -f coverage/common/coverage.lcov ]; then
                    echo "Successfully generated coverage/common/coverage.lcov"
                  else
                    echo "Error: coverage.lcov file was not created"
                  fi
                else
                  echo "Error: llvm-cov not found in PATH after sourcing swiftly env"
                  echo "PATH: $PATH"
                fi
              else
                echo "Warning: No executable binary found under .build; listing .build for debugging"
                ls -la YouSunkMyBattleshipCommon/.build || true
              fi
            else
              echo "Warning: No profdata found in YouSunkMyBattleshipCommon/.build"
            fi
          fi
          
          # Convert Swift coverage for YouSunkMyBattleshipBE
          if [ -d "YouSunkMyBattleshipBE/.build" ]; then
            echo "Converting YouSunkMyBattleshipBE coverage..."
            mkdir -p coverage/be

            # Try to find the default.profdata generated by Swift
            PROFDATA=$(find YouSunkMyBattleshipBE/.build -name "default.profdata" -print -quit || true)

            if [ -n "$PROFDATA" ] && [ -f "$PROFDATA" ]; then
              echo "Found profdata: $PROFDATA"

              # Find an executable under .build (test executable or product)
              BINARY=$(find YouSunkMyBattleshipBE/.build -type f -perm /111 -print -quit || true)

              if [ -n "$BINARY" ]; then
                echo "Using binary: $BINARY"
                
                # Use llvm-cov from Swift toolchain
                if command -v llvm-cov >/dev/null 2>&1; then
                  llvm-cov export "$BINARY" -instr-profile="$PROFDATA" -format=lcov > coverage/be/coverage.lcov 2>&1 || true
                  
                  if [ -f coverage/be/coverage.lcov ]; then
                    echo "Successfully generated coverage/be/coverage.lcov"
                  else
                    echo "Error: coverage.lcov file was not created"
                  fi
                else
                  echo "Error: llvm-cov not found in PATH"
                fi
              else
                echo "Warning: No executable binary found under .build"
                ls -la YouSunkMyBattleshipBE/.build || true
              fi
            else
              echo "Warning: No profdata found in YouSunkMyBattleshipBE/.build"
            fi
          fi
          
          # List coverage files for debugging
          echo "Coverage files available:"
          find coverage -type f 2>/dev/null | head -20 || echo "No coverage files found"

      - name: Convert LCOV to SonarQube Generic Coverage XML
        run: |
          set -e
          
          # Convert YouSunkMyBattleshipCommon coverage
          if [ -f coverage/common/coverage.lcov ]; then
            echo "Converting YouSunkMyBattleshipCommon LCOV to SonarQube Generic Coverage XML..."
            
            # Show a sample of the LCOV file to debug path issues
            echo "Sample LCOV file paths:"
            grep "^SF:" coverage/common/coverage.lcov | head -5
            
            # Use our custom converter script with workspace root for relative paths
            python3 .github/scripts/lcov_to_sonar.py coverage/common/coverage.lcov coverage/common/coverage.xml "$GITHUB_WORKSPACE"
            
            echo "Generated coverage/common/coverage.xml"
            ls -lh coverage/common/
          else
            echo "Warning: No LCOV file found for YouSunkMyBattleshipCommon"
          fi
          
          # Convert YouSunkMyBattleshipBE coverage
          if [ -f coverage/be/coverage.lcov ]; then
            echo "Converting YouSunkMyBattleshipBE LCOV to SonarQube Generic Coverage XML..."
            
            # Show a sample of the LCOV file
            echo "Sample LCOV file paths:"
            grep "^SF:" coverage/be/coverage.lcov | head -5
            
            # Use our custom converter script with workspace root for relative paths
            python3 .github/scripts/lcov_to_sonar.py coverage/be/coverage.lcov coverage/be/coverage.xml "$GITHUB_WORKSPACE"
            
            echo "Generated coverage/be/coverage.xml"
            ls -lh coverage/be/
          else
            echo "Warning: No LCOV file found for YouSunkMyBattleshipBE"
          fi
          
          echo "All coverage files:"
          find coverage -name "*.xml" -type f

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=maartene_YouSunkMyBattleshipMonorepo
            -Dsonar.projectName=YouSunkMyBattleshipMonorepo
            -Dsonar.organization=maartene
            -Dsonar.branch.name=${{ github.ref_name }}
            -Dsonar.qualitygate.wait=false

      
          
  smoketest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install curl
        run: |
          sudo apt install curl -y

      - name: Install Swift version
        run: |
          curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz && \
          tar zxf swiftly-$(uname -m).tar.gz && \
          ./swiftly init --quiet-shell-followup && \
          . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh" && \
          hash -r          

      - name: Run smoketest
        run: |
          set -e
          chmod +x smoketest.sh
          ./smoketest.sh
        
    
