name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container: swift:6.2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift version
        run: |
          curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz && \
          tar zxf swiftly-$(uname -m).tar.gz && \
          ./swiftly init --quiet-shell-followup && \
          . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh" && \
          hash -r          
        
      - name: Build and test YouSunkMyBattleshipCommon
        working-directory: YouSunkMyBattleshipCommon
        run: |
          set -e
          swift build
          swift test --enable-code-coverage

      - name: Build and test YouSunkMyBattleshipBE
        working-directory: YouSunkMyBattleshipBE
        run: |
          set -e
          swift build
          swift test --enable-code-coverage

      - name: Collect coverage data
        run: |
          set -e
          mkdir -p coverage
          
          # Copy coverage index files to coverage directory for SonarCloud
          if [ -d "YouSunkMyBattleshipCommon/.build/debug/codecov" ]; then
            echo "Found YouSunkMyBattleshipCommon coverage data"
            cp -r YouSunkMyBattleshipCommon/.build/debug/codecov coverage/common || true
          fi
          
          if [ -d "YouSunkMyBattleshipBE/.build/debug/codecov" ]; then
            echo "Found YouSunkMyBattleshipBE coverage data"
            cp -r YouSunkMyBattleshipBE/.build/debug/codecov coverage/be || true
          fi
          
          # List coverage files for debugging
          echo "Coverage files available:"
          find coverage -type f 2>/dev/null | head -20 || echo "No coverage files found"

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      
          
  # smoketest:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
      
  #     - name: Install Swift version
  #       uses: swift-actions/setup-swift@v3

  #     - name: Run smoketest
  #       run: |
  #         set -e
  #         chmod +x smoketest.sh
  #         ./smoketest.sh
        
    
